#!/bin/sh

# Auto-sync submodule(s) branch(es) with parent branch

# Get the branch just checked out in the superproject
branch=$(git rev-parse --abbrev-ref HEAD)

echo "[post-checkout] Switching submodules to branch: $branch"

git config --file .gitmodules --get-regexp path | while read -r key path; do
    if [ "$path" = "cs3b-grader" ]; then
        echo "  -> Updating $path"
        (
            cd "$path" || exit 1
            # Try to check out the same branch
            if git show-ref --verify --quiet "refs/heads/$branch"; then
                git checkout "$branch"
            else
                echo "     (no branch '$branch' in $path, skipping checkout)"
                exit 0
            fi

            # Pull latest from origin
            git pull --ff-only origin "$branch"
        )
    fi
done

# Stage the new submodule commit pointer in the superproject
git add cs3b-grader
echo "[post-checkout] Submodule commit pointer staged (remember to commit!)"
